

 The data in
[link](http://www.utsc.utoronto.ca/~butler/c32/airport.txt) are based on
a 1998 study of stress levels in children as a result of the building
of a new airport in Munich, Germany. A total of 200 children had their
epinephrine levels (a stress indicator) measured at each of four
different times: before the airport was built, and 6, 18 and 36 months
after it was built. The four measurements are labelled `epi_1`
through `epi_4`.  Out of the children, 100 were living near
the new airport (location 1 in the data set), and could be expected to
suffer stress because of the new airport. The other 100 children lived
in the same city, but outside the noise impact zone. These children
thus serve as a control group. The children are identified with
numbers 1 through 200.

As with the spaghetti-plot question about throwing baseballs and
softballs, see if you can build a pipe, one step at a time.



(a) If we were testing for the effect of time, explain briefly
what it is about the structure of the data that would make an
analysis of variance *inappropriate*.


Solution


It is the fact that each child was measured four times, rather
than each measurement being on a *different* child (with
thus $4\times 200=800$ observations altogether). It's
the same distinction as between matched pairs and a two-sample
$t$ test (and thus the previous question was a big hint for this
one). 
Extra: data in this form are called "repeated measures", and
analysing them as if they were on different individuals is wrong
because children are likely to be different from each other:
some children are likely to be high at all times and some
low. There is extra information in knowing that the sets of four
measurements are each on the same child. The analysis is beyond
our scope at the moment, but if you take D29, you'll see it
there. 



(b) Read the data into R and demonstrate that you have the right
number of observations and variables.


Solution



```{r }
my_url <- "http://www.utsc.utoronto.ca/~butler/c32/airport.txt"
airport <- read_delim(my_url, " ")
airport
```

 

There are 200 rows (children), with four `epi` measurements, a
location and a child identifier, so that looks good. (Listing a
`tibble` only lists the first ten rows, so this is good.)

Or you can `glimpse` it:

```{r }
glimpse(airport)
```

 

(I am mildly concerned about the negative `epi` measurements,
but I don't know what the scale is, so presumably they are all
right. Possibly epinephrine is measured on a log scale, so that a
negative value here is less than 1 on the original scale that we don't
see.)



(c) We are going to make a "spaghetti plot" of these data:
that is, a plot of epinephrine levels against time, with the
children identified by colour, and a separate plot for each
location. Before we get to that, we need, as usual for a
`ggplot`, all the $x$-values for our plot in one column,
all the $y$-values for our plot in one column, and a separate
column indicating which $y$ and $x$ we have (if there are more
than one). 
Use `gather` to produce something like this. (There will be
a second stage of tidy-up, which we'll do in the next part.) Save
your results in a data frame and display its first few rows, to
convince yourself that you have the right thing.


Solution


This is exactly what `gather` does, so it's what we'll
use here. Let's see how it comes out:
```{r }
airport %>% gather(when, epinephrine, epi_1:epi_4)
```

        

What makes the columns different (they're different times), what makes
them the same (they're all epinephrine levels), and the columns to
gather up (which are the consecutive ones `epi1` through
`epi4`). For the last, this also works (but is more typing):

```{r }
airport %>% gather(when, epinephrine, c(epi_1, epi_2, epi_3, epi_4))
```

        

and also this:

```{r }
airport %>% gather(when, epinephrine, starts_with("epi"))
```

        

Your choice of names is not important, though it should be something
reminiscent of what the columns actually represent. (For me, I want to
reserve the name `time` for later, which is why I used the name
`when` here.)

The one thing we have to fix up is that the time column is not 1
through 4, but `epi_1` through `epi_4`. That's what we
tackle next.



(d) Find a way to create a new column containing just the number
of the time point, and save the resulting data frame. (Two options
you can explore: `parse_number` combined with
`mutate`, or `separate`. You may
need to do some research.)


Solution



The first suggestion goes like this:

```{r }
airport %>%
  gather(when, epinephrine, epi_1:epi_4) %>%
  mutate(time = parse_number(when))
```

 

This creates a variable called `time`\endnote{I was saving the
name from earlier for this.} by pulling out only the numbers from
`when`. The only numbers are the time points, so this is
exactly what we want.

Here's the other way, using `separate` from `dplyr`:

```{r }
airport %>%
  gather(when, epinephrine, epi_1:epi_4) %>%
  separate(when, into = c("junk", "time"), sep = "_")
```

 

The job of `separate` is to split a
column, which currently contains two things mashed together, into two separate
columns. The syntax is: column to separate, names of
columns to create, and character to split at (underscore, here). The
result is that `when` has disappeared, and two new columns have
been created: `junk` which contains the text `epi` from
before the underscore and `time` which contains the number
after the underscore (the number of the time point).
This appears to have worked, but look at the top of the columns.
`time` is not actually a number, but is still text (because
`when` was text). There is an option on `separate` that
will fix that, if you want to:

```{r }
airport %>%
  gather(when, epinephrine, epi_1:epi_4) %>%
  separate(when, into = c("junk", "time"), sep = "_", convert = T)
```

 

What `convert` does is to look at the columns of output and see
what they look like. `time` looked like numbers, so it was
converted to numbers, while `junk` is unmistakably text, so
that's what it stays.

It turns out that the time can be either text or a number and the
spaghetti plot will still work, so that the `convert` above is
not necessary (it just makes things look prettier). I think what
happens is that if the numbers are not equally spaced, like 1, 2, 4,
8, having them be numbers will plot them unequally spaced as they
should be, but if they are text, they will be spaced out equally
across the plot.

From here on, I'm going to use the data frame that I
made using `parse_number`, but of course if you prefer to use
the output from `separate`, use that instead. The relevant
issue is the stuff you add to the end of your pipe each time.



(e) Use `ggplot` to plot the epinephrine values
against time, as a scatterplot. (Your plot won't
look very nice, but don't worry about that. We will fix it up
later.)


Solution


This is easy, and not very informative, but we are going
to embellish this a good deal below:
```{r }
airport %>%
  gather(when, epinephrine, epi_1:epi_4) %>%
  mutate(time = parse_number(when)) %>%
  ggplot(aes(x = time, y = epinephrine)) + geom_point()
```

 



(f) In addition to plotting the points, join the points for
the same child with lines, and make each child a different
colour. This will mean adding two things to your `aes`
and making an addition elsewhere. (Your `child` is
probably a number, but it needs to be a factor. Feed it into
`factor()` to make it one.) The resulting plot will
look very colourful, but it will be dominated by a huge legend.


Solution


Here is where the previous question was intended to be a help:
add both `colour=factor(child)` and
`group=factor(child)` to the `aes`, and
add `geom_line`:
```{r }
airport %>%
  gather(when, epinephrine, epi_1:epi_4) %>%
  mutate(time = parse_number(when)) %>%
  ggplot(aes(
    x = time, y = epinephrine, colour = factor(child),
    group = factor(child)
  )) + geom_point() + geom_line()
```

            

R actually does have over 200 different colours, but they are rather
hard to tell apart. The major benefit to the colours here is so that
you can track the same child across the picture. Or you would be able
to, if it were not for the huge legend. The one value of the legend is
that it shows you that the brown and green kids are the low-numbered
ones from location 1, and the blue and pink ones are the high-numbered
ones from location 2.

This seems not to work if you take out the `geom_point`. I'm
not sure why: it gives (for me) an error message that is not very
informative. 

Does it work if you use a data frame from earlier where the times
were text rather than numbers, and called `when`?

```{r }
airport %>%
  gather(when, epinephrine, epi_1:epi_4) %>%
  ggplot(aes(
    x = when, y = epinephrine, colour = factor(child),
    group = factor(child)
  )) + geom_point() + geom_line()
```

 

Yes it does. So you could either use `separate` earlier (with
or without `convert`), or you could use
`parse_number`, and it would work equally well. I happen to
like `parse_number`, but that's a personal preference.

The perhaps smarter way to do it, rather than repeating
`factor(child)`, is to define the factor version of
`child` first, in the pipe:

```{r }
airport %>%
  gather(when, epinephrine, epi_1:epi_4) %>%
  mutate(time = parse_number(when)) %>%
  mutate(fchild = factor(child)) %>%
  ggplot(aes(
    x = time, y = epinephrine, colour = fchild,
    group = fchild
  )) + geom_point() + geom_line()
```

 

That is perhaps a good idea. 



(g) Get rid of
the huge legend.


Solution


I showed you how to do this in a previous question.
The title at the top of my huge legend is
`factor(child)`, or `fchild` if you did
it that way.  That appears after `colour=` in
the `aes`, so `colour` is the thing that
should be `FALSE` inside `guides`. As we
found in the last question, it doesn't seem to be
necessary to get rid of `group` as well. (The
legend was actually distinguishing the
*colours*.)
```{r }
airport %>%
  gather(when, epinephrine, epi_1:epi_4) %>%
  mutate(time = parse_number(when)) %>%
  mutate(fchild = factor(child)) %>%
  ggplot(aes(
    x = time, y = epinephrine, colour = fchild,
    group = fchild
  )) + geom_point() + geom_line() + guides(colour = F)
```

            

That is a spaghetti plot living up to its name!



(h) Instead of plotting both locations together,
obtain a separate plot for each location, using *one*
`ggplot`.


Solution


Add a `facet_wrap`:
```{r }
airport %>%
  gather(when, epinephrine, epi_1:epi_4) %>%
  mutate(time = parse_number(when)) %>%
  mutate(fchild = factor(child)) %>%
  ggplot(aes(
    x = time, y = epinephrine, colour = fchild,
    group = fchild
  )) + geom_point() + geom_line() + guides(colour = F) +
  facet_wrap(~location)
```

                 

The blue and pink spaghetti strands on the right are because the
location 2 children were the high-numbered ones, and the high-numbered
children in that big legend that we got rid of were pink and blue.



(i) How would you describe the difference in
epinephrine (stress) levels between the two locations?
Does this make sense, given where the locations are?


Solution


The ones on the right, from location 2, are
consistently close to 250, with no apparent change
over time. The ones on the left, from location 1,
are, depending on your tastes, more variable, have a
higher mean, usually increase from time 1 to the
other time points, or are potentially higher in
terms of epinephrine. (I'd take any of those.)
The location 2 children were our control group;
their stress levels should not have been affected by
the building of the airport, since they weren't
close to it. So we'd expect to see, and do see,
consistent levels over time. The location 1
children, however, were the ones potentially
affected by the building of the airport. It looks as
if the building of the airport is associated with
"potentially higher", "typically higher",
"increased" or "more variable" stress levels
(whatever words you used above). Unless there is
something different about the children who live near
the new airport (apart from the fact that they live
near the new airport), it looks as if the new
airport is having a bad effect on their stress
levels. This is distressing, but not exactly a
surprise.
As for any effect on stress levels over time, there
is not much especially consistent coming out of the
spaghetti plot that I can see. Maybe the stress
levels at the first time point, before the airport
was built, are lower than the ones after that on average.
(If you find something like this and it looks
justifiable, it's good.)


  
